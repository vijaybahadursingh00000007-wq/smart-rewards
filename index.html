<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Smart Rewards | Secure Firebase Edition</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, query, orderByChild, limitToLast, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB0IVGY1UWz5qnLrfrA6Cijq9XIC1mjDsM",
            authDomain: "smart-rewards-c7a7f.firebaseapp.com",
            projectId: "smart-rewards-c7a7f",
            storageBucket: "smart-rewards-c7a7f.firebasestorage.app",
            messagingSenderId: "726958238934",
            appId: "1:726958238934:web:39a8653642b4e300e86d77",
            databaseURL: "https://smart-rewards-c7a7f-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ADMOB IDS (WEB2APP READY) ---
        const AD_CONFIG = {
            appId: "ca-app-pub-2957528773378331~9557250144",
            banner: "ca-app-pub-2957528773378331/3060641472",
            rewarded: "ca-app-pub-2957528773378331/1507547340"
        };

        window.appState = {
            points: 0,
            isLoggedIn: localStorage.getItem('isLoggedIn') === 'true',
            phone: localStorage.getItem('user_phone') || '',
            referral: "FEST-" + Math.floor(1000 + Math.random() * 9000),
            festName: "Happy New Year! 2026",
            festBonus: 100,
            deviceId: localStorage.getItem('app_device_id') || 'DEV-' + Math.random().toString(36).substr(2, 9),
            appLink: "https://smartrewards.link/download" // <-- YAHAN APNA LINK DAALEIN
        };
        localStorage.setItem('app_device_id', window.appState.deviceId);

        window.runSecurityCheck = () => {
            const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (!tz.includes("Asia/Kolkata") && !tz.includes("Calcutta")) {
                document.body.innerHTML = `<div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; text-align:center; background:#fff;"><h2 style="color:#ef4444;">VPN Detected!</h2><p style="color:#64748b; margin-top:10px;">Please turn off VPN.</p></div>`;
                return false;
            }
            return true;
        };

        window.handleAuth = async () => {
            if(!window.runSecurityCheck()) return;
            let p = document.getElementById('phone').value;
            if(p.length < 10) return alert("Sahi number daalo bhai!");

            const userRef = ref(db, 'users/' + p);
            const deviceRef = ref(db, 'devices/' + window.appState.deviceId);

            const devSnap = await get(deviceRef);
            if(devSnap.exists() && devSnap.val().phone !== p) return alert("Device locked!");

            const snapshot = await get(userRef);
            if (snapshot.exists()) {
                window.appState.points = snapshot.val().points || 0;
            } else {
                await set(userRef, { phone: p, points: 0, deviceId: window.appState.deviceId, referral: window.appState.referral, joinDate: new Date().toISOString() });
                await set(deviceRef, { phone: p });
            }
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('user_phone', p);
            location.reload();
        };

        window.syncPoints = async (amt) => {
            const userRef = ref(db, 'users/' + window.appState.phone);
            const snapshot = await get(userRef);
            let currentPoints = snapshot.exists() ? (snapshot.val().points || 0) : 0;
            let updatedPoints = currentPoints + amt;
            window.appState.points = updatedPoints;
            await update(userRef, { points: updatedPoints });
            window.render();
        };

        // --- REAL ADMOB REWARDED AD LOGIC ---
        window.actionTask = (pts) => {
            if (typeof showRewardedVideo !== 'undefined') {
                showRewardedVideo(); // Web2App Call
                window.onRewardedVideoFinished = async () => {
                    await window.syncPoints(pts);
                    alert("Points Added: " + pts);
                };
            } else {
                alert("Loading Ad...");
                setTimeout(() => window.syncPoints(pts), 2000);
            }
        };

        window.fetchLeaders = async () => {
            const usersRef = ref(db, 'users');
            const topQuery = query(usersRef, orderByChild('points'), limitToLast(10));
            const snapshot = await get(topQuery);
            let leaders = [];
            snapshot.forEach((child) => { leaders.push(child.val()); });
            return leaders.reverse();
        };

        // NEW: Withdrawal Logic with Firebase Storage
        window.payout = async () => {
            let u = document.getElementById('upi').value;
            if(!u || window.appState.points < 5000) return alert("Min ‚Çπ50 (5000 pts) required!");
            
            const historyRef = ref(db, 'withdrawals/' + window.appState.phone);
            const newRequest = push(historyRef);
            
            const requestData = {
                amount: (window.appState.points / 100).toFixed(2),
                upi: u,
                status: 'Pending',
                date: new Date().toLocaleString()
            };

            await set(newRequest, requestData);
            await window.syncPoints(-window.appState.points);
            alert("Request Sent! Status can be tracked in Profile.");
        };

        // NEW: Fetch history for Profile
        window.fetchHistory = async () => {
            const historyRef = ref(db, 'withdrawals/' + window.appState.phone);
            const snapshot = await get(historyRef);
            let history = [];
            snapshot.forEach((child) => { history.push(child.val()); });
            return history.reverse();
        };

        window.render = async () => {
            const screen = document.getElementById('screen-view');
            if(!screen) return;

            if(window.currentScreen === 'leaderboard') {
                screen.innerHTML = `<div class="header"><div class="logo-text">Top Earners</div></div><div id="leader-list" style="padding:15px"><p style="text-align:center">Loading...</p></div>`;
                const players = await window.fetchLeaders();
                let listHtml = players.map((p, i) => `
                    <div class="task-row">
                        <div style="font-weight:800; color:var(--primary); width:25px">${i+1}.</div>
                        <div style="flex:1"><b>${p.phone.substring(0,3)}XXXX${p.phone.substring(8)}</b></div>
                        <div style="color:var(--accent); font-weight:800">${p.points} Pts</div>
                    </div>`).join('');
                document.getElementById('leader-list').innerHTML = listHtml || '<p>No data</p>';
            } else if(window.currentScreen === 'profile') {
                screen.innerHTML = views.profile();
                const histDiv = document.getElementById('history-list');
                const history = await window.fetchHistory();
                histDiv.innerHTML = history.map(h => `
                    <div style="background:#fff; padding:10px; border-radius:10px; margin-bottom:10px; border:1px solid #eee; font-size:12px; text-align:left;">
                        <div style="display:flex; justify-content:space-between"><b>‚Çπ${h.amount}</b> <span style="color:#f59e0b">${h.status}</span></div>
                        <div style="color:#64748b; margin-top:4px">${h.date}</div>
                    </div>`).join('') || '<p style="font-size:12px; color:#64748b">No history found.</p>';
                lucide.createIcons();
            } else {
                screen.innerHTML = views[window.currentScreen]();
            }
            lucide.createIcons();
        };

        window.nav = (scr, el) => {
            if(!window.runSecurityCheck()) return;
            window.currentScreen = scr;
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            window.render();
        };

        window.onload = async () => {
            if(!window.runSecurityCheck()) return;
            if(window.appState.isLoggedIn) {
                const userRef = ref(db, 'users/' + window.appState.phone);
                const snapshot = await get(userRef);
                if (snapshot.exists()) window.appState.points = snapshot.val().points || 0;
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                window.currentScreen = 'home';
                window.render();
            }
        };
    </script>
    
    <style>
        :root { --primary: #1e3a8a; --accent: #f59e0b; --danger: #ef4444; --success: #10b981; --bg: #f8fafc; --white: #ffffff; --text-muted: #64748b; --fest-gradient: linear-gradient(135deg, #ff416c, #ff4b2b); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); }
        #app { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; padding-bottom: 90px; }
        .auth-container { padding: 40px 25px; text-align: center; background: var(--white); min-height: 100vh; display: flex; flex-direction: column; justify-content: center; }
        .btn-auth { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; width: 100%; font-weight: 700; cursor: pointer; }
        .header { background: var(--white); padding: 18px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
        .logo-text { font-weight: 800; font-size: 20px; color: var(--primary); }
        .fest-card { background: var(--fest-gradient); color: white; margin: 15px; padding: 20px; border-radius: 20px; position: relative; overflow: hidden; }
        .card { background: var(--white); margin: 15px; padding: 20px; border-radius: 20px; border: 1px solid #e2e8f0; }
        .task-row { background: var(--white); margin: 0 15px 12px; padding: 16px; border-radius: 18px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; }
        .bottom-nav { position: fixed; bottom: 12px; left: 10px; right: 10px; background: var(--primary); border-radius: 20px; display: flex; justify-content: space-around; padding: 12px 0; }
        .nav-link { color: rgba(255,255,255,0.5); display: flex; flex-direction: column; align-items: center; font-size: 8px; cursor: pointer; border: none; background: none; }
        .nav-link.active { color: white; }
        .avatar { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .hidden { display: none; }
        input { width: 100%; padding: 14px; border-radius: 12px; border: 1.5px solid #e2e8f0; margin-bottom: 15px; outline: none; }
        .section-title { margin: 20px 18px 10px; font-weight: 800; font-size: 16px; color: var(--primary); }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-view" class="auth-container">
        <h1 style="color:var(--primary); font-weight:800; font-size:30px">Smart Rewards</h1>
        <p style="color:var(--text-muted); margin-bottom:30px">Secure Cloud Storage ‚òÅÔ∏è</p>
        <input type="number" id="phone" placeholder="Enter Mobile Number">
        <button class="btn-auth" onclick="window.handleAuth()">Start Earning</button>
    </div>

    <div id="main-content" class="hidden">
        <div id="screen-view"></div>
        <nav class="bottom-nav">
            <button class="nav-link active" onclick="window.nav('home', this)"><i data-lucide="home"></i>Home</button>
            <button class="nav-link" onclick="window.nav('tasks', this)"><i data-lucide="zap"></i>Tasks</button>
            <button class="nav-link" onclick="window.nav('leaderboard', this)"><i data-lucide="trophy"></i>Leaders</button>
            <button class="nav-link" onclick="window.nav('wallet', this)"><i data-lucide="wallet"></i>Wallet</button>
            <button class="nav-link" onclick="window.nav('refer', this)"><i data-lucide="share-2"></i>Refer</button>
            <button class="nav-link" onclick="window.nav('profile', this)"><i data-lucide="user"></i>Profile</button>
        </nav>
    </div>
</div>

<script>
    const views = {
        home: () => `
            <div class="header"><div class="logo-text">SmartRewards</div><div style="font-weight:700; color:var(--accent)">${window.appState.points} Pts</div></div>
            <div class="fest-card" onclick="window.claimFest()"><h2>${window.appState.festName}</h2><p>Claim Gift! üéÅ</p><i data-lucide="party-popper" size="80"></i></div>
            <div class="card" style="margin-top:0"><p style="font-size:12px">Current Balance</p><h1 style="font-size:32px; font-weight:800; color:var(--primary)">‚Çπ${(window.appState.points/100).toFixed(2)}</h1></div>
            <h3 class="section-title">Social Tasks</h3>
            <div class="social-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:0 15px;">
                <div class="social-box" onclick="window.socialTask('Instagram', 20, '#')" style="background:#fff; padding:15px; border-radius:18px; border:1px solid #e2e8f0; text-align:center;"><i data-lucide="instagram" color="#E1306C"></i><br><span>Follow IG</span></div>
                <div class="social-box" onclick="window.socialTask('Facebook', 20, '#')" style="background:#fff; padding:15px; border-radius:18px; border:1px solid #e2e8f0; text-align:center;"><i data-lucide="facebook" color="#1877F2"></i><br><span>Like FB</span></div>
            </div>`,
        tasks: () => `<div class="header"><div class="logo-text">Tasks</div></div><div style="padding:10px"><div class="card" onclick="window.actionTask(30)" style="display:flex; justify-content:space-between; align-items:center"><b>Watch Ad</b><br><small>+30 points</small></div><div style="color:var(--accent); font-weight:800">+30</div></div></div>`,
        wallet: () => `<div class="header"><div class="logo-text">Wallet</div></div><div class="card" style="text-align:center"><h1 style="font-size:40px; color:var(--primary)">‚Çπ${(window.appState.points/100).toFixed(2)}</h1><input type="text" id="upi" placeholder="Enter UPI ID"><button onclick="window.payout()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:700">Withdraw Now</button></div>`,
        refer: () => `<div class="header"><div class="logo-text">Refer</div></div><div style="padding:30px; text-align:center"><h2 style="font-weight:800">Invite & Earn ‚Çπ10</h2><div style="margin:20px 0; background:#eee; padding:15px; border-radius:15px; font-weight:800; font-size:22px">${window.appState.referral}</div><button onclick="window.shareWA()" style="background:#25D366; color:white; border:none; padding:15px; border-radius:50px; font-weight:700; width:100%">WhatsApp Invite</button></div>`,
        profile: () => `<div class="header"><div class="logo-text">Profile</div></div><div style="padding:20px; text-align:center"><div class="avatar">${window.appState.phone.substring(0,1)}</div><h3>${window.appState.phone}</h3><div style="margin-top:20px;"><h4 style="margin-bottom:10px; text-align:left;">Withdrawal History</h4><div id="history-list">Loading...</div></div><button onclick="window.logout()" style="margin-top:30px; color:var(--danger); border:none; background:none; font-weight:700">Logout Account</button></div>`
    };

    window.claimFest = async () => {
        let lastFest = localStorage.getItem('last_f');
        if(lastFest === window.appState.festName) return alert("Already claimed!");
        await window.syncPoints(window.appState.festBonus);
        localStorage.setItem('last_f', window.appState.festName);
        alert("Bonus Added!");
    };
    window.socialTask = async (n, p, u) => { alert("Opening " + n); window.open(u, '_blank'); setTimeout(async () => { await window.syncPoints(p); alert("Points Added!"); }, 3000); };
    
    // UPDATED SHARE LOGIC (REFER CODE + DOWNLOAD LINK)
    window.shareWA = () => {
        const msg = `Bhai mast app hai, try kar! Har invite pe ‚Çπ10 milte hain.\nMera invite code: ${window.appState.referral}\nDownload Link: ${window.appState.appLink}`;
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`);
    };
    
    window.logout = () => { if(confirm("Logout?")) { localStorage.clear(); location.reload(); } };
</script>
</body>
</html>
